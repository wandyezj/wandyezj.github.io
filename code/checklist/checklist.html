<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Checklist</title>
</head>

<body>

    <!--
        Generate a configurable list layout with clickable boxes and allow export to an image

        Allow export and sharing via URL

        Pieces:

        Configuration
            - hostable and pointable on any URL
                - determine which parser to use based off .md or .json suffix
            - fixed set of options
                - checkbox
                - likert - future
        HTML Render and Selection
        
        save
            - image
            - URL hash encode
            - json - configuration + answers
        load
            - configuration + answers
            - json configuration
            - MD configuration
            - URL hash decode

        Canvas Draw and Image Export / Download

        Principles:
            - hostable anywhere - self contained HTML page
            - sharable and private
                - no telemetry
                - no storage or persistance of data outside of users machine
            - configurable and customizable, with sharable configurations
            - machine parsable if shared
            - secure
                - do not want to allow links that people can click, except to know safe domains (maybe wikipedia links are ok?)
                - defend against HTML injection from input sources
            - compatible this means old configurations and renders continue to work
                - can be done by versioning, point to specific HTML page
                - or keep everything backwards compatible and have shim layers that translate to new logic based on an embedded version number
    -->
    <button id="button_save_to_json">Save to JSON</button>
    <div id="div_configuration">

    </div>

    <script>


        // Example actually use markdown as all input
        const defaultConfigurationJson = {
            title: "example configuration title",
            description: "example configuration description",

            // All independent items
            items: [
                // items and order they appear in
                {
                    // id is derivable from title in md but must be specified in json
                    id: "example_checkbox_item_title",
                    title: "example checkbox item title",
                    description: "example checkbox item description",
                    input: "checkbox"
                }
            ],

            // layout
            // probably want a separate layout section that can determine how items are layed out
            // maybe sections and subsections with their own titles and descriptions
            // should these sections be infinitely nestable?
            // do section titles become part of the item id? Probably yes when layed out with markdown

            // state of all items
            // id -> value
            // id should be present in the items
            // value is dependent on the item type
            // empty assumes default value
            state: {
                // by default empty
            }

        }

        // whitespace matters
        const defaultConfigurationMarkdown = `
# example title
> example description

- [ ] example item
    > example item description
- [ ] example item 2
    > example item description

`;

        /**
         * create json configuration from a markdown description
         */
        function parseMarkdownToConfiguration(markdownInput) {
            const markdown = markdownInput.trim()

            const lines = markdown.split("\n");
            // Could scrub empty lines for utility, but then need a mapping of lines to orignal line numbers for errors

            /**
             * Title for the whole list
             */
            let listTitle = undefined;

            /**
             * description for the whole list
             */
            let listDescription = undefined;

            /**
             * items in the list
             * Each item has
             * - title
             * - description
             * - input- the type of input 
             */
            const listItems = [];


            // Delimiters
            const delimiterListTitle = "# ";
            const delimiterListDescription = "> ";
            const delimiterListItemCheckbox = "- [ ] ";
            const delimiterListItemDescription = "    > ";

            for (let i = 0; i < lines.length; i++) {
                const linePrevious = i > 0 ? lines[i - 1] : undefined;
                const line = lines[i];
                const lineNext = i + 1 < lines.length ? lines[i + 1] : undefined;
                console.log(line)

                // parse the line
                if (line.startsWith(delimiterListTitle)) {
                    // List Title
                    if (listTitle === undefined) {
                        listTitle = line.substring(delimiterListTitle.length).trim();
                    } else {
                        console.error(`line [${i}]: duplicate list title - only a single list title may be defined`);
                    }

                    // List Description
                    // Must be next line after title
                    if (lineNext !== undefined && lineNext.startsWith(delimiterListDescription)) {
                        listDescription = lineNext.substring(delimiterListDescription.length).trim();
                        // already parsed line go to next
                        i++;
                    }

                } else if (line.startsWith(delimiterListItemCheckbox)) {
                    // List Item Checkbox

                    const itemTitle = line.substring(delimiterListItemCheckbox.length).trim();
                    const itemInput = "checkbox";
                    let itemDescription = undefined;

                    if (lineNext !== undefined && lineNext.startsWith(delimiterListItemDescription)) {
                        // List Item Description
                        itemDescription = lineNext.substring(delimiterListItemDescription.length).trim();

                        // Already parsed the line go to next
                        i++;
                    }

                    // mapping is imperfect since it filters characters
                    const itemBaseId = titleToId(itemTitle);
                    let itemId = itemBaseId;

                    // id must not already be present
                    // if id is already present attach a numeric count to the end to make it unique
                    let itemIdCount = 0;
                    while (-1 !== listItems.findIndex(({ id }) => id === itemId)) {
                        itemIdCount++;
                        itemId = itemBaseId + "_" + itemIdCount;
                    }


                    listItems.push({
                        id: itemId,
                        title: itemTitle,
                        description: itemDescription,
                        input: itemInput,
                    });
                } else {
                    // Unknown What is this?
                    if (line !== "") {
                        console.error(`line [${i}]: unknown value [${line}]`);
                    }
                }
            }

            // Assemble configuration Json
            const configurationJson = {
                title: listTitle,
                description: listDescription,
                items: listItems,
            }

            return configurationJson;
        }

        /**
         * Map item title to id
         * id can only consist of lowercase letters, numbers, and underscores
         * converts uppercase to lowercase
         * removes duplicate spaces and replaces the space with an underscore
         */
        function titleToId(title) {
            const characters = Array.from(title.toLowerCase());

            // characters allowed in an identifier
            const alphabet = "abcdefghijklmnopqrstuvwxyz";
            const numbers = "0123456789"
            const space = " "

            const valid = alphabet + numbers + space;

            const validCharacters = Array.from(valid);

            // filter out invalid characters, remove duplicate spaces, map spaces to underscores
            const idArray = characters
                .filter((c) => validCharacters.includes(c))
                .filter((c, index, array) =>
                    // no duplicate spaces
                    c !== space || (c === space && index - 1 >= 0 && array[index - 1] !== space)
                ).map((c) => c === space ? "_" : c);

            const id = idArray.join("");
            return id;
        }

        /**
         * load the configuration to html on the pace so it can be manipulated
         */
        function loadConfiguration(configuration) {

            const div = document.getElementById("div_configuration");

            const { title, description, items } = configuration;

            const defaultTitle = "List";
            const defaultDescription = "";

            const listTitle = title || defaultTitle;

            const elementListTitle = document.createElement("h1");
            elementListTitle.innerText = listTitle;

            const elementListDescription = document.createElement("p");
            elementListDescription.innerText = description || defaultDescription;

            document.title = listTitle;

            div.appendChild(elementListTitle);
            div.appendChild(elementListDescription);

            // append all list elements
            const children = items.map(({ id, title, description, input }) => {

                const elementDiv = document.createElement("div");



                // determine input type
                // why not aimply assign? - security plus elements have different needs
                if (input === "checkbox") {
                    const elementInput = document.createElement("input");
                    elementInput.type = "checkbox";
                    elementInput.name = title;
                    elementInput.id = id;

                    const elementLabel = document.createElement("label");
                    elementLabel.for = id;
                    elementLabel.innerText = title;

                    elementDiv.appendChild(elementInput);
                    elementDiv.appendChild(elementLabel);

                } else {
                    console.error(`invalid type for item [${input}]`);
                    const p = document.createElement("p");
                    p.innerText = `item [${name}] invalid type [${input}] for item`;
                    elementDiv.appendChild(p);
                }

                return elementDiv;

            });

            div.append(...children);

        }


        /**
         * Get a snapshot of the current configuration
         */
        function getConfigurationSnapshotJson(configuration) {
            // clone configuration
            const snapshot = JSON.parse(JSON.stringify(configuration));
            // empty state
            snapshot["state"] = {};

            // retrieve current state and bind it to the snapshot
            snapshot.items.forEach(({id, input})=> {
                const element = document.getElementById(id);
                if (element) {
                    if (input === "checkbox") {
                        const checked = element.checked;
                        snapshot.state[id] = checked;
                    }
                }
            });

            return snapshot

        }

        /**
         *  get snapshot of the current configurations answers and save to JSON
         */
        function saveSnapshotToJson() {
            const snapshot = getConfigurationSnapshotJson(gconfiguration);
            const snapshotJson = JSON.stringify(snapshot, undefined, "    ");
            console.log(snapshotJson);
        }

        /**
         * currently loaded configuration
         */
        let gconfiguration = undefined;

        // function run on setup
        function initialize() {
            const configuration = parseMarkdownToConfiguration(defaultConfigurationMarkdown);
            console.log(configuration);
            loadConfiguration(configuration);
            gconfiguration = configuration;
        
        
            document.getElementById("button_save_to_json").onclick = saveSnapshotToJson;
        }

        initialize();



    </script>
</body>

</html>